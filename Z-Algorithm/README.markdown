# Z-Algorithm å­—ç¬¦ä¸²æœç´¢

ç›®æ ‡ï¼šç»™å®šä¸€ä¸ªæ¨¡å¼ä¸²ï¼Œç”¨ Swift å†™ä¸€ä¸ªçº¿æ€§æ—¶é—´å¤æ‚åº¦çš„åŒ¹é…ç®—æ³•ï¼Œè¿”å›åœ¨å­—ç¬¦ä¸²ä¸­å‡ºç°çš„ä½ç½®ã€‚

æ¢è€Œè¨€ä¹‹ï¼Œæˆ‘ä»¬éœ€è¦å®ç°ä¸€ä¸ª `String` çš„æ‰©å±•æ–¹æ³• `indexsOf(pattern:String)`, èƒ½å¤Ÿè¿”å›ä¸€ä¸ª `[Int]` æ•°ç»„ä»£è¡¨æ‰€æœ‰æ¨¡å¼ä¸²å‡ºç°çš„ç´¢å¼•ä½ç½®ï¼Œæˆ–è€…è¿”å› `nil` å¦‚æœæ²¡æœ‰åœ¨å­—ç¬¦ä¸²ä¸­æ‰¾åˆ°ã€‚

ä¸¾ä¸ªä¾‹å­:

```swift
let str = "Hello, playground!"
str.indexesOf(pattern: "ground")   // Output: [11]

let traffic = "ğŸš—ğŸš™ğŸšŒğŸš•ğŸš‘ğŸšğŸš—ğŸš’ğŸššğŸšğŸš›ğŸšğŸğŸšœğŸš—ğŸğŸš’ğŸš²ğŸš•ğŸš“ğŸšŒğŸš‘"
traffic.indexesOf(pattern: "ğŸš‘") // Output: [4, 21]
```

è®¸å¤šå­—ç¬¦ä¸²æœç´¢ç®—æ³•éƒ½ä¼šæœ‰ä¸€ä¸ªé¢„å¤„ç†å‡½æ•°è®¡ç®—ä¸€ä¸ªè¡¨ç”¨åœ¨éšåçš„è®¡ç®—è¿‡ç¨‹ä¸­ã€‚è¿™ä¸ªè¡¨å¯ä»¥å¯ä»¥èŠ‚çœæ¨¡å¼ä¸²åŒ¹é…é˜¶æ®µçš„ä¸€äº›æ—¶é—´ï¼Œå› ä¸ºå¯ä»¥é¿å…ä¸€äº›ä¸å¿…è¦çš„å­—ç¬¦ä¸²æ¯”è¾ƒã€‚Z-Algorithm å°±æ˜¯ä¼—å¤šé¢„å¤„ç†å‡½æ•°çš„ä¸€ç§ã€‚å°½ç®¡å®ƒç”Ÿä¸ºé¢„å¤„ç†å‡½æ•°ï¼ˆåœ¨ [KMP](../Knuth-Morris-Pratt/) ç®—æ³•å’Œå…¶ä»–ç®—æ³•ä¸­å°±æ‰¿æ‹…äº†ä¸€ä¸ªè¿™æ ·çš„è§’è‰²ï¼‰ï¼Œä½†æ˜¯æœ¬æ–‡å°†ä»‹ç»å¦‚ä½•å°†å®ƒä½œä¸ºå­—ç¬¦ä¸²æœç´¢ç®—æ³•ä½¿ç”¨ã€‚

### Z-Algorithm æ¨¡å¼ä¸²çš„å‰ç¼€

æ­£å¦‚æœ¬æ–‡æ‰€è¯´ï¼ŒZ-Algorithm æ˜¯ç®—æ³•å¼€å§‹éƒ¨åˆ†é€šè¿‡å¤„ç†æ¨¡å¼ä¸²è®¡ç®—å‡ºä¸€ä¸ªè·³è¿‡éå¿…è¦æ¯”è¾ƒçš„è¡¨ã€‚Z-Algorithm è®¡ç®—æ¨¡å¼ä¸²åå¾—åˆ°ä¸€ä¸ªæ•´æ•°æ•°ç»„ï¼ˆæ–‡çŒ®ä¸­ç§°ä¹‹ä¸º `Z`ï¼‰æ¯ä¸ªå…ƒç´ ç§°ä½œ `Z[i]`, è¡¨ç¤ºæ¨¡å¼ä¸² `P` çš„ä»¥ `i` å¼€å§‹çš„æœ€é•¿å­å­—ç¬¦ä¸²çš„å‰ç¼€ä¸ `P` çš„å‰ç¼€ç›¸åŒ¹é…çš„é•¿åº¦ã€‚ç®€è€Œè¨€ä¹‹å°±æ˜¯ `Z[i]` è®°å½•äº† `P[i...|P|]` æœ€é•¿çš„ä¸ `P` å‰ç¼€ç›¸åŒçš„å‰ç¼€ã€‚ä¸¾ä¸ªä¾‹å­ï¼Œå‡è®¾ `P = "ffgtrhghhffgtggfredg"`ã€‚é‚£ä¹ˆ `z[5] =0 (f...h...)`ï¼Œ`z[9] = 4 (ffgtr...ffgtg...)` å’Œ `z[15] = 1 (ff..fr..)`ã€‚ï¼ˆè¯‘è€…æ³¨ï¼šå¥½å§ï¼Œè¿™ä¸ªä¾‹å­å…¶å®å¾ˆéš¾çœ‹ï¼Œç›¸ä¿¡ä½ å¯èƒ½æ•°çš„çœ¼éƒ½èŠ±äº†ï¼Œè¿™é‡Œ `z[5] = hghhffgtggfredg` ä¸åŸå­—ç¬¦ä¸²æ¯”è¾ƒå‰ç¼€ä¸€ä¸ªéƒ½æ²¡æœ‰æ‰€ä»¥ç»“æœä¸º0ï¼Œè€Œ `z[9] = ffgtggfredg` ä¸åŸå­—ç¬¦ä¸²æ¯”è¾ƒä¸€ä¸‹ç»“æœä¸º `ffgt` ç›¸åŒï¼Œç»“æœä¸º 4ã€‚ï¼‰

ä½†æ˜¯æˆ‘ä»¬å¦‚ä½•è®¡ç®— `Z `? åœ¨ä»‹ç»è¿™ä¸ªç®—æ³•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆä»‹ç»ä¸€ä¸ªä¸‹ Z-box è¿™ä¸ªæ¦‚å¿µã€‚ ä¸€ä¸ª Z-Box  å«æœ‰ `(left,right)` ä¸€å¯¹å€¼ï¼Œç”¨æ¥åœ¨è®¡ç®—è¿‡ç¨‹ä¸­è®°å½•å­å­—ç¬¦ä¸²ä¸ `P` å‰ç¼€ç›¸åŒçš„é•¿åº¦ã€‚`left` å’Œ `right` è¿™ä¸¤ä¸ªç´¢å¼•å€¼å„è‡ªä»£è¡¨å­å­—ç¬¦ä¸²çš„å·¦è¾¹ç•Œå’Œå³è¾¹ç•Œç´¢å¼•ã€‚Z-Algorithm å®šä¹‰æ¯”è¾ƒæ„Ÿæ€§ï¼Œå®ƒä» `k-1` å¼€å§‹ï¼Œè®¡ç®—äº†æ¨¡å¼ä¸²ä¸­æ¯ä¸ªä½ç½® `k`ã€‚ç®—æ³•èƒŒåçš„æ€æƒ³æ˜¯ä¹‹å‰è®¡ç®—çš„å€¼å¯ä»¥åŠ å¿« `Z[k + 1]` çš„æ¼”ç®—ï¼Œé¿å…é‡å¤å·²ç»æ¯”è¾ƒè¿‡çš„ã€‚æ€è€ƒä¸€ä¸‹ï¼šå¦‚æœè¿­ä»£åˆ° `k = 100`, åˆ†ææ¨¡å¼ä¸² `100` ä½ç½®å¦‚ä½•è®¡ç®—ã€‚æ‰€æœ‰çš„ `Z[1]` åˆ° `Z[99]` å·²ç»è®¡ç®—è¿‡å¹¶ä¸” `left = 70`, `right = 120`ã€‚è¿™æ„å‘³ç€å­å­—ç¬¦ä¸²é•¿åº¦ä¸º `51` ä¸”æ˜¯ä» `70` å¼€å§‹åˆ° `120`ç»“æŸï¼Œè€Œä¸”è¿˜æ˜¯ä¸æ¨¡å¼ä¸²å‰ç¼€ç›¸åŒ¹é…çš„ã€‚æ¨ç†ä¸€ä¸‹åå¯ä»¥è®¤ä¸ºä» `100` å¼€å§‹ï¼Œé•¿åº¦ä¸º `21` çš„å­—ç¬¦ä¸æ¨¡å¼ä¸²ä¸­ä» `30` å¼€å§‹é•¿åº¦ä¸º `21` çš„å­å­—ç¬¦ä¸²ç›¸åŒ¹é…ï¼ˆå› ä¸ºæˆ‘ä»¬æ˜¯åœ¨ä¸€ä¸ªä¸æ¨¡å¼ä¸²å‰ç¼€ç›¸åŒ¹é…çš„å­å­—ç¬¦ä¸²ä¸­ï¼‰ã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥é¿å…é¢å¤–çš„æ¯”è¾ƒç›´æ¥ç”¨ `Z[30]` æ¥è®¡ç®— `Z[100]`ã€‚

è¿™æ˜¯è¿™ä¸ªç®—æ³•èƒŒåçš„ç®€å•æ€æƒ³ã€‚æ— æ³•é€šè¿‡ä¹‹å‰è®¡ç®—çš„å€¼ç›´æ¥è¿›è¡Œå¤„ç†çš„æƒ…å†µå¾ˆå°‘ï¼Œä½†è¿˜æ˜¯æœ‰ä¸€äº›æ¯”è¾ƒéœ€è¦å¤„ç†ä¸€ä¸‹ã€‚

ä¸‹é¢æ˜¯è®¡ç®— `Z-array` çš„ä»£ç ï¼š

```swift
func ZetaAlgorithm(ptrn: String) -> [Int]? {

    let pattern = Array(ptrn.characters)
    let patternLength: Int = pattern.count

    guard patternLength > 0 else {
        return nil
    }

    var zeta: [Int] = [Int](repeating: 0, count: patternLength)

    var left: Int = 0
    var right: Int = 0
    var k_1: Int = 0
    var betaLength: Int = 0
    var textIndex: Int = 0
    var patternIndex: Int = 0

    for k in 1 ..< patternLength {
        if k > right {  //åœ¨ Z-box ä¹‹å¤–: æ¯”è¾ƒå­—ç¬¦ä¸²ç›´åˆ°ä¸åŒ¹é…
            patternIndex = 0

            while k + patternIndex < patternLength  &&
                pattern[k + patternIndex] == pattern[patternIndex] {
                patternIndex = patternIndex + 1
            }

            zeta[k] = patternIndex

            if zeta[k] > 0 {
                left = k
                right = k + zeta[k] - 1
            }
        } else {  // åœ¨ Z-box ä¸­
            k_1 = k - left + 1
            betaLength = right - k + 1

            if zeta[k_1 - 1] < betaLength { // å…¨éƒ¨åœ¨ Z-box ä¸­ï¼š å¯ä»¥ä½¿ç”¨ä¹‹å‰è®¡ç®—è¿‡çš„
                zeta[k] = zeta[k_1 - 1]
            } else if zeta[k_1 - 1] >= betaLength { // ä¸å…¨åœ¨ Z-box ä¸­ï¼š å¿…é¡»å¤„ç†ä¸€äº›æ¯”è¾ƒ
                textIndex = betaLength
                patternIndex = right + 1

                while patternIndex < patternLength && pattern[textIndex] == pattern[patternIndex] {
                    textIndex = textIndex + 1
                    patternIndex = patternIndex + 1
                }

                zeta[k] = patternIndex - k
                left = k
                right = patternIndex - 1
            }
        }
    }
    return zeta
}
```

è®©æˆ‘ä»¬ä¸¾ä¾‹è¯´æ˜ä¸Šé¢ä»£ç ã€‚å‡è®¾ `P = â€œabababbbâ€ ` ã€‚ç®—æ³•ä» `k = 1` å¼€å§‹ï¼Œ `left = right = 0` ã€‚å› æ­¤æ²¡æœ‰â€œæ¿€æ´»â€ Z-box ï¼Œåˆå› ä¸º `k > right` å¼€å§‹æ¯”è¾ƒ `P[1]` å’Œ `p[0]`ã€‚


       01234567
    k:  x
       abababbb
       x
    Z: 00000000
    left:  0
    right: 0

ç”±äºç¬¬ä¸€æ¬¡æ¯”è¾ƒåä»¥ `P[1]` å¼€å§‹çš„å­—ç¬¦ä¸²ä¸ `P` å‰ç¼€ä¸åŒ¹é…ï¼Œå› æ­¤ `z[1] = 0`ï¼Œ`left` å’Œ `right` ä¹Ÿæ²¡åŠ¨ã€‚å¼€å§‹ç»§ç»­ä¸‹å» `k = 2`ï¼Œæˆ‘ä»¬æœ‰ `2 > 0` ï¼Œå› æ­¤ç»§ç»­æ¯”è¾ƒ `P[2]` å’Œ `P[0]`ã€‚è¿™æ¬¡å­—ç¬¦åŒ¹é…äº†ï¼Œç»§ç»­æ¯”è¾ƒç›´åˆ°ä¸åŒ¹é…ã€‚åœ¨ç¬¬ `6` çš„ä½ç½®å‘ç”Ÿä¸åŒ¹é…ï¼Œç›¸åŒ¹é…çš„å­—ç¬¦å…±æœ‰ `4` ä¸ªï¼Œå› æ­¤ `Z[2] = 4`ï¼Œ`left = k = 2` , `right = k + Z[k] - 1 = 5`ã€‚ç°åœ¨æœ‰äº†ç¬¬ä¸€ä¸ª Z-box, å­—ç¬¦ä¸²ä¸º `"abab"`(æ³¨æ„ä¸ `P` çš„å‰ç¼€ç›¸åŒ¹é…) ï¼Œä»¥ `left = 2` å¼€å§‹ã€‚

       01234567
    k:   x
       abababbb
       x
    Z: 00400000
    left:  2
    right: 5

å¼€å§‹å¤„ç† `k = 3`ã€‚å› æ­¤ `3 < = 5` ï¼Œå› æ­¤åœ¨ä¹‹å‰è®¡ç®—çš„ Z-box ä¸­å¹¶ä¹Ÿæ˜¯ `P` çš„å‰ç¼€çš„ä¸€éƒ¨åˆ†ã€‚å› æ­¤çœ‹ä¸€ä¸‹ä¹‹å‰è®¡ç®—çš„ç»“æœï¼Œ `k_1 = k - left = 1` æ˜¯å‰é¢ ä¸`P[k]` ç›¸åŒçš„å­—ç¬¦ï¼Œ`Z[1] = 0` å¹¶ä¸” `0 < (right - k + 1 = 3)`ï¼Œæ‰€ä»¥ä¸€å®šæ˜¯åœ¨ Z-box èŒƒå›´å†…ï¼Œå¯ä»¥ç›´æ¥ä½¿ç”¨ä¹‹å‰è®¡ç®—çš„å€¼ã€‚ä»¤ `Z[3] = Z[1] = 0`ï¼Œ`left` å’Œ `right` ä¿æŒä¸å˜ã€‚

è®¡ç®— `k = 4` ä¼šæ‰§è¡Œ å¤–å±‚ `if` çš„ `else` é€»è¾‘åˆ†æ”¯ã€‚åœ¨å†…éƒ¨ `if` ä½ç½® `k_1 = 2` ä¸” `(Z[2] = 4) >= 5 - 4 + 1` ã€‚å› æ­¤å­å­—ç¬¦ `	P[k...r]` ä¸ `P` çš„å‰ `right - k + 1 = 2` ä¸ªå­—ç¬¦åŒ¹é…ï¼Œä½†æ˜¯åé¢çš„å¹¶ä¸çŸ¥é“ã€‚æ‰€ä»¥å¿…é¡»ç»§ç»­æ¯”è¾ƒä» `r + 1 = 6` ä½ç½®å­—ç¬¦å’Œ`right - k + 1 = 2` ä½ç½®çš„å­—ç¬¦ã€‚ ç”±äº `P[6] != P[2]`, æ‰€ä»¥ç»“æœä¸º `Z[k] = 6 - 4 = 2`, `left = 4`ï¼Œ `right = 5`ã€‚

       01234567
    k:     x
       abababbb
       x
    Z: 00402000
    left:  4
    right: 5

å¾ªç¯åˆ° `k = 5`,å› ä¸º `k <= right` ï¼Œ `(Z[k_1] = 0) < (right - k + 1 = 1)`, ç»“æœ `Z[k] = 0`ã€‚ ç»§ç»­å¾ªç¯ `6` å’Œ `7`ï¼Œæ‰§è¡Œå¤–å±‚ `if` çš„ç¬¬ä¸€ä¸ªåˆ†æ”¯ï¼Œä½†æ˜¯éƒ½æ˜¯ä¸åŒ¹é…ï¼Œä½†æ˜¯ ç®—æ³•å¾—åˆ°çš„ Z-æ•°ç»„ ä¸º `Z = [0, 0, 4, 0, 2, 0, 0, 0]`ã€‚

Z-Algorithm ç®—æ³•æ˜¯çº¿æ€§æ—¶é—´å¤æ‚åº¦ï¼Œè¿›ä¸€æ­¥è¯´ï¼ŒZ-Algorithm è®¡ç®—é•¿åº¦ä¸º `n` çš„å­—ç¬¦ä¸² `P` æ—¶é—´å¤æ‚åº¦ä¸º `O(n)`ã€‚

å­—ç¬¦ä¸²é¢„å¤„ç†Z-Algorithm ç®—æ³•å®ç°åœ¨ [ZAlgorithm.swift](./ZAlgorithm.swift) æ–‡ä»¶ä¸­ã€‚

### Z-Algorithm å­—ç¬¦ä¸²æœç´¢ç®—æ³• 

ä¸Šé¢è®¨è®ºçš„ Z-Algorithm æ˜¯æœ€ç®€å•çš„çº¿æ€§æ—¶é—´å¤æ‚åº¦çš„å­—ç¬¦ä¸²åŒ¹é…ç®—æ³•ã€‚åªéœ€è¦å°†æ¨¡å¼ä¸² `P` å’Œ æ–‡æœ¬ `T` è¿æ¥åˆ°ä¸€ä¸ªå­—ç¬¦ä¸­ `S = P$T`ï¼Œ è¿™é‡Œ `$` æ˜¯ä¸€ä¸ªä¸åœ¨ `P` æˆ–è€… `T` ä¸­çš„å­—ç¬¦ã€‚ç”¨ä¸Šé¢çš„ç®—æ³•è®¡ç®— `S` å¾—åˆ° Z æ•°ç»„ã€‚ç°åœ¨åªéœ€è¦éå†ä¸€ä¸‹ Z æ‰¾åˆ°ç­‰äº `n` ï¼ˆæ¨¡å¼ä¸²é•¿åº¦ï¼‰çš„å…ƒç´ ã€‚å¦‚æœæ‰¾åˆ°äº†å°±ç®—æ‰¾åˆ°äº†ã€‚

```swift
extension String {

    func indexesOf(pattern: String) -> [Int]? {
        let patternLength: Int = pattern.characters.count
        /* ç”¨ Z-Algorithm è®¡ç®—æ¨¡å¼ä¸²å’Œæ–‡æœ¬è¿æ¥åçš„å­—ç¬¦ä¸² */
        let zeta = ZetaAlgorithm(ptrn: pattern + "ğŸ’²" + self)

        guard zeta != nil else {
            return nil
        }

        var indexes: [Int] = [Int]()

        /* éå† zeta æ•°ç»„å°è¯•æ‰¾åŒ¹é…çš„æ¨¡å¼ä¸² */
        for i in 0 ..< zeta!.count {
            if zeta![i] == patternLength {
                indexes.append(i - patternLength - 1)
            }
        }

        guard !indexes.isEmpty else {
            return nil
        }

        return indexes
    }
}
```

ä¸¾ä¸ªä¾‹å­å§ï¼Œä»¤ `P = â€œCATAâ€` ï¼Œ`T = "GAGAACATACATGACCAT"` ä½œä¸ºæ¨¡å¼ä¸²å’Œå¾…æŸ¥æ–‡æœ¬ã€‚æŠŠä»–ä»¬ç”¨ `$` è¿æ¥èµ·æ¥ï¼Œå¾—åˆ° `S =  "CATA$GAGAACATACATGACCAT"`ã€‚ç”¨ç®—æ³•è®¡ç®—åå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š

                1         2
      01234567890123456789012
      CATA$GAGAACATACATGACCAT
    Z 00000000004000300001300
                ^

éå† Z æ•°ç»„åœ¨ `10` çš„ä½ç½®æˆ‘ä»¬æ‰¾åˆ° `Z[10] = 4 = n`ã€‚å› æ­¤å¯ä»¥è®¤ä¸ºåœ¨æ–‡æœ¬ `10 - n - 1 = 5` çš„ä½ç½®æ‰¾åˆ°äº†åŒ¹é…çš„å­—ç¬¦ä¸²ã€‚

æ­£å¦‚ä¹‹å‰è¯´çš„é‚£æ ·ï¼Œè¿™ä¸ªç®—æ³•å¤æ‚åº¦æ˜¯çº¿æ€§çš„ã€‚å®šä¹‰`n` å’Œ `m` ä½œä¸ºæ¨¡å¼ä¸²å’Œæ–‡æœ¬çš„é•¿åº¦ã€‚æœ€åçš„å¾—åˆ°çš„å¤æ‚åº¦ä¸º `O(n + m + 1) = O(n + m)`ã€‚

å£°æ˜ï¼šæœ¬ä»£ç åŸºäº1997å¹´å‰‘æ¡¥å¤§å­¦å‡ºç‰ˆç¤¾ Dan Gusfield ç¼–å†™çš„[ "Algorithm on String, Trees and Sequences: Computer Science and Computational Biology"](https://books.google.it/books/about/Algorithms_on_Strings_Trees_and_Sequence.html?id=Ofw5w1yuD8kC&redir_esc=y)  æ‰‹å†Œã€‚

**ä½œè€… Matteo Dunnhofer ï¼Œè¯‘è€… [KeithMorning](https://github.com/KeithMorning/swift-algorithm-club-cn)**
